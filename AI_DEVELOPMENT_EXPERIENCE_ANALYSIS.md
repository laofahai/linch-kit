# LinchKit AI开发框架：最终工程蓝图 (v5.2 权威版)

**版本**: 5.2 (权威版)
**状态**: **行动纲领 (已锁定)**
**目标**: 基于“可验证的信任”与“人机交互协作”原则，实现一个健壮、安全、高效的AI原生开发框架。

---

## 1. 根本问题诊断：我们为何必须变革

项目在AI协作开发模式下，遇到了一个根本性的困境，我们将其定义为 **“信任的错位与责任的真空”**。

**核心病因**: 我们构建了一个要求AI无条件信任我们提供的上下文，但又未能给AI提供一个可靠的、机器可验证的信任基础的系统。AI的幻觉和错误，并非其自身的能力缺陷，而是这个系统性矛盾的必然产物。

此问题具体体现在以下几个方面：

-   **叙事性过载**: 为人类编写的、长达数百行的“规则”文档，充满了AI无法有效处理的模糊性和叙事性语言。
-   **语义鸿沟**: AI工具难以理解代码背后复杂的设计模式和架构分层。
-   **僵化仪式**: 固定的启动流程创造了“责任真空”，强迫AI在一个不透明的环境里工作。

不解决这些根本问题，任何上层的修补都将是徒劳的。因此，我们必须从根本上重构AI的工作环境。

---

## 2. 最终愿景与设计原理：我们要构建什么，以及为何这样构建

我们的最终目标是构建一个全新的、以“人机协作”为核心的AI原生开发框架。其设计不仅是功能的堆砌，更是对潜在风险的直接回应。

### 2.1. 核心交互：带“安全锁”的交互式工作流

-   **是什么**: 所有AI驱动的开发任务，都将通过统一的 `bun run workflow:run` 命令进入一个确定性的状态机。其核心是 `PENDING_APPROVAL` (待审批) 状态，即AI生成的任何行动计划都必须经过人类开发者批准后方可执行。
-   **为什么**: 这是对“信任错位”问题的直接解决方案。它将最终控制权交还给开发者，使AI从一个“黑盒执行者”转变为一个强大的“规划顾问”。

### 2.2. 终极保障：双层防御守护者

-   **是什么**: 一个双层的守护体系，结合了本地的便利防线和远程的强制防线。
-   **为什么**: 任何纯本地的Git钩子（如`pre-commit`）都可以通过 `--no-verify` 命令被轻易绕过。因此，我们必须在CI/CD管道中设置一个**不可绕过**的最终防线。

### 2.3. 知识库：从“阅读材料”到“可验证规则”

-   **是什么**: `ai-context`目录将被重塑为一个结构化的、可供机器精确查询的“可验证知识库”，主要包含“规则即代码”（`rules/`）和“JSON Schema定义”（`schemas/`）。
-   **为什么**: 这是对“叙事性过载”和“语义鸿Gou”问题的解决方案。我们不再期望AI去“阅读理解”人类文档，而是让工作流引擎去“执行校验”机器规则。

### 2.4. 核心技术实现策略

-   **代码溯源：工作流回执机制**: 为解决“如何区分AI与人工代码”的问题，工作流成功执行后，会自动生成包含文件哈希值的“回执文件”作为证据。守护者只校验“回执”，不关心代码内容。人工修改可通过 `bun run workflow:manual-receipt` 命令签发“人工回执”。
-   **用户行为引导**: 我们不修改开发工具，而是采用“社会契约 + 技术保障”的策略。如果有人试图绕过流程，无法绕过的**远程CI检查**将阻止其代码被合入，从而反向强制所有人遵守规范。

---

## 3. 执行计划：一个清晰、务实的工程路线图

本章节定义了我们如何从现状到达最终愿景的完整路径，包含了交互的演进、资产的重构和功能的开发。

### 3.1. 交互模式演进路径：从后台MVP到IDE集成

为优先验证核心逻辑、降低风险，我们的交互体验将分两步走：

1.  **Phase 0 (起点)**: **后台终端交互**。开发者像往常一样在IDE中对AI下达指令，但守护者会在**后台终端**打印出执行计划并暂停，等待开发者在**终端**中输入`y/n`来完成审批。此阶段追求“功能可用”，不追求“体验完美”。
2.  **Phase 3 (终点)**: **无缝IDE集成**。开发者在IDE中通过标准化的 `/start` 命令启动工作流，IDE界面将以卡片等形式优雅地呈现计划，并允许开发者直接通过点击按钮完成审批、编辑等所有操作。此阶段追求“体验完美”。

### 3.2. 现有资产重构策略：三步走计划

为确保平稳过渡，所有现有文档和脚本将按以下三步进行处理：

1.  **第一步 (Phase 0-1): 识别与隔离**
    -   **文档**: 立即将 `GEMINI.md`, `Essential_Rules.md` 等旧的引导性文档移至临时的 `legacy_docs/` 目录，净化主干。
    -   **脚本**: 暂时**全部保留**，不做任何修改，以确保现有流程不受影响。新工作流的开发在隔离的命名空间下进行。
2.  **第二步 (Phase 2): 吸收与替换**
    -   当新引擎功能完善后，系统性地分析所有旧脚本。一部分将被重构为符合新规范的“规则即代码”，并入新引擎；另一部分将被新引擎的“规划-审批-执行”循环所完全替代，并被标记为“可废弃”。
3.  **第三步 (Phase 3): 清理与归档**
    -   在新工作流成为唯一标准后，**彻底删除**所有被标记为“可废弃”的旧脚本和临时的 `legacy_docs/` 目录，达成最终的、干净的项目状态。

### 3.3. 四阶段实施路线图

这是功能开发的具体时间线：

-   **阶段 0: 即时价值 - 最小化可行产品 (MVP) (目标: < 1周)**
    -   **目标**: 验证核心概念，并通过一个最小化的、基于命令行的“交互式确认”功能，立即提升安全性。
    -   **任务**: 扩展现有守护者脚本，实现“AI生成简化计划 -> 命令行打印 -> 等待用户y/n确认 -> 条件化执行”的最小闭环。

-   **阶段 1: 奠定基础 - 工作流引擎MVP (目标: 2-3周)**
    -   **目标**: 将阶段0的PoC转化为一个可扩展的、基础扎实的工作流引擎。
    -   **任务**: 清理战场、创建`bun run workflow:run`命令、实现三状态FSM、管理状态文件、并让守护者调用新引擎。

-   **阶段 2: 增强能力 - 规则与Schema (目标: 3-4周)**
    -   **目标**: 通过引入结构化数据（Schema）和自动化验证（“规则即代码”），使引擎成熟化。
    -   **任务**: 定义Schema、实现“规则即代码”、扩展状态机至七状态、并构建高级交互功能。

-   **阶段 3: 坚固堡垒 - 最终防护与全面推广 (目标: 2-3周)**
    -   **目标**: 部署终极安全措施，并正式将新框架确立为标准的开发流程。
    -   **任务**: 部署双层防御守护者、实现所有健壮性工程、并完成最终的文档迁移和清理工作。

---

## 4. 行动指令

**蓝图已定，即刻启程。**

1.  **创建分支**: `git checkout -b feature/refactor-ai-workflow-v5.2`
2.  **启动阶段 0**: 立即开始执行“即时价值MVP”任务，为项目交付核心的交互式确认功能。
