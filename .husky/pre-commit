#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢æ•æ„Ÿä¿¡æ¯æäº¤
echo "ğŸ” Running security checks..."

# æ£€æŸ¥æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
if git diff --cached --name-only | xargs grep -l "postgresql://.*:.*@.*" 2>/dev/null; then
  echo "âŒ å‘ç°æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²ï¼Œè¯·ä½¿ç”¨ç¯å¢ƒå˜é‡"
  echo "   è¯·å°†æ•æ„Ÿä¿¡æ¯ç§»åŠ¨åˆ° .env.local æ–‡ä»¶ä¸­"
  exit 1
fi

# æ£€æŸ¥ API å¯†é’¥æ¨¡å¼
if git diff --cached --name-only | xargs grep -l -E "(api_key|apikey|secret_key|password).*=.*['\"][^'\"]{20,}" 2>/dev/null; then
  echo "âŒ å‘ç°å¯èƒ½çš„ API å¯†é’¥æˆ–å¯†ç ï¼Œè¯·ä½¿ç”¨ç¯å¢ƒå˜é‡"
  exit 1
fi

# æ£€æŸ¥ Supabase æˆ–å…¶ä»–äº‘æœåŠ¡å‡­æ®
if git diff --cached --name-only | xargs grep -l -E "(supabase\.co|amazonaws\.com|firebase\.com).*:.*@" 2>/dev/null; then
  echo "âŒ å‘ç°äº‘æœåŠ¡å‡­æ®ï¼Œè¯·ä½¿ç”¨ç¯å¢ƒå˜é‡"
  exit 1
fi

echo "âœ… å®‰å…¨æ£€æŸ¥é€šè¿‡"

# è¿è¡Œ lint å’Œç±»å‹æ£€æŸ¥
npm run lint
npm run type-check
