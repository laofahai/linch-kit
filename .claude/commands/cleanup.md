---
allowed-tools: [Bash, Glob, Read]
description: ".claude 目录智能清理工具"
---

# /cleanup - .claude 目录智能清理工具

**清理 .claude 目录中的冗余、过时和临时文件**

## 🔍 智能清理流程

**Claude 将使用内置工具按规则执行清理**

### Phase 1: 扫描和分析
- 使用 **Glob** 工具扫描 `.claude` 目录结构
- 使用 **Read** 工具分析文件内容和创建时间
- 识别符合清理规则的文件

### Phase 2: 规则匹配
- **隔离区文件**: `**/quarantine/**` 模式文件
- **临时文档**: 包含 `TEMP`, `TEST_RESULTS`, `PLAN` 的 .md 文件
- **重复命令**: `*-lite.md`, `*-v2.md` 等版本化文件
- **过期快照**: 超过7天的 `*-snapshots.json` 文件

### Phase 3: 安全检查
- 检查白名单：`settings.json`, `commands/start.md` 等核心文件
- 验证文件是否被其他配置引用
- 确认删除不会破坏系统功能

### Phase 4: 用户确认
- 显示将要删除的文件列表和原因
- 等待用户明确确认
- 执行清理并显示结果

## ✅ 保留的核心文件

- `settings.json` - Claude Code 主配置
- `commands/start.md` - AI Workflow 启动器  
- `commands/cleanup.md` - 本清理工具
- `context-verification/` - 上下文验证数据
- `evolution-engine/` - 演进引擎历史（如果有用）

### 清理规则

1. **🧪 测试和调试文件** (24小时后)
   - `test-*.md`, `test-*.ts`, `debug-*.js`
   - 白名单：重要的测试配置文件

2. **📦 版本化文件** (48小时后)  
   - `*-v2.ts`, `*-v3.md`, `enhanced-*-v4.ts`
   - 保留生产版本和 dist 目录

3. **⏰ 临时文件** (12小时后)
   - `temp-*.ts`, `tmp-*.md`, `example-*.js`

4. **📋 日志和缓存** (72小时后)
   - `*.log`, `*.cache`, `*.tmp`

5. **🗑️ 空文件和占位符**
   - 空内容文件
   - 只包含 TODO 的文件
   - 占位符文件

## 💡 使用建议

- **开发中**: 使用 `bun run cleanup:preview` 预览
- **每日清理**: 使用 `bun run cleanup`  
- **自动触发**: PostToolUse Hook 会自动执行轻度清理

## 🎯 常见场景

### 场景1: 开发会话结束清理
```bash
# 预览要清理的文件
!bun run cleanup:preview

# 确认清理（需要用户同意）
!bun run cleanup
```

### 场景2: Hook检测到过多临时文件
当看到此错误时：
```
🚨 项目需要清理！
• ⚙️ 发现 37 个工作流状态文件 (建议<20)
```

**处理步骤**：
1. Claude 自动运行 `bun run cleanup:preview`
2. 向用户展示清理列表
3. 等待用户确认后执行清理

### 场景3: Token使用优化
- **清理前**: 大量临时文件影响上下文质量
- **清理后**: 减少token消耗，提高AI响应质量

## 🛡️ 安全保护机制

### 白名单保护
系统自动保护以下文件：
- `README.md`, `CHANGELOG.md` - 项目文档
- `package.json`, `tsconfig.json` - 配置文件
- `.claude/settings.json` - Claude配置
- `test-*.config.ts` - 测试配置
- `dist/`, `node_modules/` - 构建产物

### 智能年龄检测
- **新文件保护**: 24小时内的文件不会被清理
- **活跃文件保护**: 正在使用的工作流状态文件
- **重要性评估**: 基于文件路径和内容的重要性分析

### 用户确认机制
- **必须预览**: Claude 不能跳过预览步骤
- **明确确认**: 必须得到用户明确同意
- **详细说明**: 清楚解释将删除哪些文件

## 🔧 高级功能

### 清理统计
每次清理后显示：
- 扫描文件数量
- 清理文件数量
- 节省的存储空间
- Token消耗优化效果

### 智能推荐
系统会分析项目状态并推荐：
- **最佳清理时机**: 基于文件活跃度
- **清理策略**: 保守/标准/积极
- **性能影响**: 清理对开发效率的提升

## 📊 效果指标

### 清理效果
- **存储优化**: 减少项目体积
- **Token效率**: 提高AI上下文质量
- **开发体验**: 减少干扰文件
- **性能提升**: 加快文件检索速度

### 建议频率
- **开发期间**: 每周1-2次
- **重构阶段**: 每天清理
- **发布前**: 完整清理

---

**安全特性**: 
- 内置白名单保护重要文件
- 预览模式避免误删
- 智能年龄检测  
- **零意外删除**: 用户确认机制确保安全
- **可回滚**: Git版本控制提供额外保护

**核心原则**: 安全第一，用户确认，智能检测，提升效率