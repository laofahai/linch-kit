---
allowed-tools: [Bash, Glob, Read, LS, TodoWrite]
description: "AI Workflow Session 智能结束器 - 完整的 session 结束和清理工作流"
---

# 🔚 /end-session - AI Workflow Session 智能结束器

**完整的 LinchKit AI Workflow Session 结束流程，包含智能清理和状态报告**

## 🎯 Session 结束流程概览

Claude 将自动执行以下智能化流程，减少用户确认需求：

### 📊 Step 1: 收集 Session 状态
Claude 自动收集当前 Session 的状态信息：
- 当前分支和 Git 状态
- Session 时间戳和标识
- 工作流状态文件分析

### 📋 Step 2: 智能任务状态分析
Claude 将：
1. 使用 TodoWrite 检查所有当前任务状态
2. 智能识别已实际完成但状态未更新的任务
3. 自动将已实现的功能标记为 `completed`
4. 将未完成任务合理转移到下次 session

### 🏗️ Step 3: 架构合规性检查
Claude 自动执行架构合规性验证（如工具可用）

### 🧹 Step 4: 智能清理执行
Claude 将基于安全分析自动执行清理：

**🤖 自动清理策略**：
- **零风险文件**（自动清理）：
  - 空文件、.DS_Store、Thumbs.db、*.tmp
  - 过期缓存文件（超过7天）
  - 系统临时文件和调试输出
  
- **低风险文件**（智能评估后清理）：
  - 版本化文件 (*-v2.*, *-v3.*, 超过48小时)
  - 测试输出文件 (test-*.log, debug-*.md, 超过24小时)
  - 过期工作流状态（超过7天且未被引用）

- **保护文件**（永不清理）：
  - 核心配置文件 (settings.json, commands/*.md)
  - 源代码文件和正式文档
  - 24小时内创建的文件

### 📝 Step 5: 智能 Session 总结生成
Claude 基于以下数据源自动生成完整总结：
- Git 提交历史和文件差异分析
- TodoWrite 记录的任务状态变化
- 架构影响评估和质量指标收集
- 自动创建结构化总结文档

### 🔄 Step 6: 工作流状态管理
Claude 智能管理工作流状态：
- 状态完整性检查和数据归档
- 无缝状态转换和性能优化
- 为下次 session 预准备最优环境

### 🎉 Step 7: 智能结束报告
Claude 自动生成完整的 session 结束报告，包含：
- Session 执行统计和成果分析
- 智能清理结果和安全验证
- 下次 session 的智能建议
- 工作流状态优化总结

### 🧠 Step 8: 深入分析用户需求并生成下一个 Session Prompt

**🔍 深入思考流程**：
Claude 将基于以下信息源进行深度分析：
1. **用户本次 Session 提供的需求**：分析用户在 `/end-session` 时提出的具体需求
2. **上一个 Session 完成情况**：分析已完成的任务质量和影响
3. **现有文档和实现状态**：分析项目当前状态和技术债务
4. **项目架构和约束**：确保下一步工作符合 LinchKit 设计原则

**📋 需求确认机制**：
```bash
# Claude 将执行以下分析并寻求用户确认：
1. 分析用户在 end-session 时的需求描述
2. 分析当前项目状态和文档
3. 识别下一步真正应该做的任务
4. 生成具体的 next session 建议并寻求用户确认
```

**🤖 智能任务生成**：
- **如用户有明确需求**：基于用户需求生成具体的任务分解和执行计划
- **如用户无明确需求**：基于项目状态和架构分析，生成智能的任务建议
- **任务优先级评估**：根据依赖关系、技术债务、用户体验等因素确定优先级
- **资源需求分析**：预估所需的工具、包、时间等资源需求

**✅ 用户确认流程**：
在生成最终 Session Prompt 前，Claude 将：
1. 展示分析结果和建议任务列表
2. 询问用户是否同意或需要调整
3. 根据用户反馈优化任务定义
4. 生成最终的 Session Prompt 文档

## 🛡️ 安全保护机制

**自动安全检查**：
- 白名单保护所有核心配置文件
- 年龄检测排除24小时内的新文件
- 引用检查保护被使用的文件
- Git 状态检查保护未提交的重要变更

## ⚡ 执行特点

- **零等待**：Claude 基于智能分析自动执行最优策略
- **安全第一**：多重保护机制确保不误删重要文件
- **智能决策**：基于文件特征和项目状态的自动化判断
- **完整报告**：详细的执行结果和下次 session 建议

---

**核心原则**: 
- 🛡️ **安全第一**: 永不意外删除重要文件
- 🤖 **智能自动**: 减少用户确认，提升开发效率
- 🧠 **数据驱动**: 基于实际项目状态的智能决策
- 📊 **透明报告**: 详细的执行过程和结果分析

**使用效果**: 
- ✨ 更清洁的项目结构
- 🚀 更高效的AI响应  
- 📈 更好的开发体验
- 🔍 更准确的上下文分析