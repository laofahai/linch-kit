# AI Agent 执行指南与任务标准

**版本**: 1.0
**创建日期**: 2025-07-17
**状态**: 生效
**用途**: 为 AI Agent 执行 LinchKit 框架稳定化任务提供明确的操作规范

---

## 1. 任务执行标准模板

### 1.1 标准任务格式

每个任务必须按照以下格式定义，确保 AI Agent 能够准确理解和执行：

```markdown
### 任务ID: [阶段]-[序号]-[简称]
**任务名称**: [具体、明确的任务描述]
**预计工时**: [1-8小时/1-3天/1周]
**依赖任务**: [任务ID列表，如无则标注"无"]
**任务类型**: [开发/测试/文档/重构/优化]

#### 前置条件
- [ ] 条件1：[具体的可验证条件]
- [ ] 条件2：[具体的可验证条件]
- [ ] 条件3：[具体的可验证条件]

#### 执行步骤
1. **步骤名称**
   ```bash
   # 具体命令
   bun run [具体命令]
   ```
   预期结果：[描述预期输出]

2. **步骤名称**
   - 具体操作说明
   - 需要修改的文件：`path/to/file.ts`
   - 关键代码示例或模板

3. **步骤名称**
   - 验证命令：`bun test [specific-test]`
   - 成功标志：[具体的成功指标]

#### 验收标准
- [ ] 功能验收：[可量化的功能完成标准]
- [ ] 质量验收：[测试覆盖率/性能指标等]
- [ ] 文档验收：[相关文档更新要求]
- [ ] 代码审查：[需要通过的检查项]

#### 失败处理
- **回滚步骤**：
  1. [具体的回滚操作]
  2. [恢复命令]
- **补救措施**：
  - 如果 X 失败，则执行 Y
  - 备选方案：[描述备选实现路径]

#### 输出物
- [ ] 代码文件：[具体文件列表]
- [ ] 测试文件：[测试文件列表]
- [ ] 文档更新：[文档列表]
- [ ] 配置变更：[配置文件列表]
```

### 1.2 任务粒度指南

#### 原子任务（1-2小时）
- 单一功能点的实现
- 单个文件的重构
- 特定 bug 修复
- 单元测试编写

#### 小型任务（2-4小时）
- 模块功能完善
- 跨文件的小规模重构
- 集成测试编写
- API 接口实现

#### 中型任务（4-8小时）
- 完整功能模块开发
- 跨包的功能集成
- 性能优化实施
- 架构局部调整

#### 大型任务（1-3天）
- 核心系统重构
- 新包的创建和实现
- 端到端功能开发
- 架构升级

## 2. AI Agent 执行流程

### 2.1 任务开始前检查清单

```typescript
// AI Agent 必须执行的前置检查
const preTaskChecklist = {
  1: "检查当前分支：git branch --show-current",
  2: "验证工作目录：git status",
  3: "查询项目上下文：bun run ai:session query [任务关键词]",
  4: "检查依赖任务：验证所有依赖任务的完成状态",
  5: "验证前置条件：逐项检查任务定义的前置条件",
  6: "创建任务跟踪：TodoWrite - 标记任务为 in_progress"
}
```

### 2.2 执行过程监控

```typescript
// 执行过程中的强制检查点
const executionCheckpoints = {
  beforeCode: "Graph RAG 查询现有实现",
  afterCode: "运行 bun run validate:light",
  beforeCommit: "运行 bun run validate",
  afterTest: "检查测试覆盖率是否达标",
  onError: "立即停止并报告错误详情"
}
```

### 2.3 任务完成验证

```typescript
// 任务完成的强制验证
const completionValidation = {
  1: "所有验收标准必须打勾",
  2: "所有输出物必须存在",
  3: "质量检查必须通过",
  4: "文档必须同步更新",
  5: "TodoWrite - 标记任务为 completed"
}
```

## 3. 代码生成规范

### 3.1 必须遵循的编码标准

```typescript
// 每个生成的代码文件必须包含
export const codeStandards = {
  // 1. 严格的 TypeScript 类型
  noAny: true,
  strictNullChecks: true,
  
  // 2. 完整的错误处理
  errorHandling: "所有异步操作必须 try-catch",
  
  // 3. 输入验证
  validation: "所有公共函数必须验证参数",
  
  // 4. 日志记录
  logging: "使用 @linch-kit/core 的 logger",
  
  // 5. 测试覆盖
  testing: "同步编写单元测试"
}
```

### 3.2 禁止的操作

```typescript
// AI Agent 绝对禁止的操作
export const prohibitedActions = [
  "直接在 main/master/develop 分支工作",
  "使用 console.log/console.error",
  "跳过 Graph RAG 查询",
  "使用 any 类型",
  "提交未测试的代码",
  "忽略 ESLint 错误",
  "硬编码配置值",
  "创建重复功能"
]
```

## 4. 错误处理与恢复

### 4.1 常见错误场景

| 错误类型 | 识别方法 | 处理策略 |
|---------|---------|---------|
| 构建失败 | `bun build` 报错 | 1. 分析错误日志<br>2. 修复类型错误<br>3. 重新构建 |
| 测试失败 | `bun test` 不通过 | 1. 定位失败测试<br>2. 分析原因<br>3. 修复代码或测试 |
| 依赖冲突 | 包版本不兼容 | 1. 检查 package.json<br>2. 使用兼容版本<br>3. 更新 bun.lockb |
| Graph RAG 失败 | 查询无结果 | 1. 调整查询关键词<br>2. 使用多个相关词<br>3. 检查索引状态 |

### 4.2 恢复流程

```bash
# 标准恢复流程
1. git stash              # 保存当前更改
2. git checkout [文件]     # 恢复特定文件
3. git reset --hard HEAD  # 完全重置（慎用）
4. 重新执行任务步骤        # 从失败点继续
```

## 5. 质量保证机制

### 5.1 自动化检查

每个任务完成前必须通过：

```bash
# 轻量级验证（快速）
bun run validate:light

# 完整验证（提交前）
bun run validate

# CI 级别验证（PR 前）
bun run validate:ci
```

### 5.2 代码审查要点

- [ ] 代码符合 LinchKit 架构规范
- [ ] 没有重复实现已有功能
- [ ] 适当的错误处理和日志
- [ ] 充分的单元测试覆盖
- [ ] 清晰的代码注释（仅在必要时）
- [ ] 性能考虑和优化

## 6. 文档同步要求

### 6.1 必须更新的文档

| 变更类型 | 需要更新的文档 |
|---------|--------------|
| API 变更 | API 参考文档、类型定义文件 |
| 新功能 | 功能文档、使用示例 |
| 架构调整 | 架构文档、设计文档 |
| 配置变更 | 配置指南、环境变量文档 |
| 破坏性变更 | 迁移指南、变更日志 |

### 6.2 文档更新模板

```markdown
## 功能名称

### 概述
[简要描述功能用途]

### API 参考
```typescript
// 接口定义
interface FeatureName {
  // ...
}
```

### 使用示例
```typescript
// 基础用法
import { feature } from '@linch-kit/package'

// 示例代码
```

### 配置选项
| 选项 | 类型 | 默认值 | 描述 |
|-----|------|-------|------|
| ... | ... | ... | ... |

### 注意事项
- [重要提示1]
- [重要提示2]
```

## 7. 性能与优化指南

### 7.1 性能基准

- 构建时间：< 10秒
- 启动时间：< 3秒
- 内存使用：< 512MB
- API 响应：< 200ms

### 7.2 优化检查清单

- [ ] 避免不必要的重渲染
- [ ] 使用适当的缓存策略
- [ ] 优化包体积和依赖
- [ ] 实施代码分割
- [ ] 使用性能监控工具

## 8. 安全考虑

### 8.1 安全检查清单

- [ ] 不硬编码敏感信息
- [ ] 验证所有用户输入
- [ ] 使用安全的依赖版本
- [ ] 实施适当的权限控制
- [ ] 加密敏感数据传输

### 8.2 安全最佳实践

```typescript
// 环境变量管理
import { env } from '@linch-kit/core'

// 输入验证
import { z } from 'zod'
const schema = z.object({
  // 定义验证规则
})

// 权限检查
import { checkPermission } from '@linch-kit/auth'
```

## 9. 持续改进

### 9.1 反馈机制

- 任务执行问题记录
- 性能指标收集
- 质量趋势分析
- 改进建议收集

### 9.2 指南更新流程

1. 收集执行反馈
2. 分析常见问题
3. 更新指南内容
4. 验证新流程
5. 发布更新版本

---

**最后更新**: 2025-07-17
**下次审查**: 2025-07-24

本指南是 AI Agent 执行 LinchKit 框架稳定化任务的权威参考。所有任务执行必须严格遵循本指南的要求。